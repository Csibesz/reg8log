<?phpif(ini_get('register_globals')) exit("<center><h3>Error: Turn that damned register globals off!</h3></center>");$parent_page=true;$index_dir='';require $index_dir.'include/common.php';require $index_dir.'include/code/code_encoding8anticache_headers.php';require $index_dir.'include/code/code_prevent_repost.php';require $index_dir.'include/info/info_lockdown.php';if(!$lockdown_bypass_system_enabled) exit('<h3 align="center">Lockdown bypass system is disabled by administrator!</h3>');if(!isset($_GET['username'])) exit('<h3 align="center">Error: username parameter is not set</h3>');if($lockdown_bypass_system_enabled==1 and $_GET['username']!='admin') exit('<h3 align="center">Currently, lockdown bypass system is enabled only for the admin account!</h3>');if($lockdown_bypass_system_enabled==2 and $_GET['username']=='admin') exit('<h3 align="center">Currently, lockdown bypass system is disabled for the admin account!</h3>');$_username=$_GET['username'];require $index_dir.'include/code/code_check_account_lockdown.php';if(!isset($lockdown)) {	if(!$lockdown_bypass_system_also4ip_lockdown) exit('<h3 align=center><span style="white-space: pre; color: #0a8;">'.htmlspecialchars($_GET['username'], ENT_QUOTES, 'UTF-8').'</span>\'s account is not locked!</h3><center><a href="index.php">Login page</a></center>');		$set_last_attempt=true;	require $index_dir.'include/code/code_check_ip_lockdown.php';		if(!isset($ip_lockdown)) exit('<h3 align=center>Neither of account <span style="white-space: pre; color: #0a8;">'.htmlspecialchars($_GET['username'], ENT_QUOTES, 'UTF-8').'</span> and IP <span style="white-space: pre; color: #0a8;">'.$_SERVER['REMOTE_ADDR'].'</span> are locked!</h3><center><a href="index.php">Login page</a></center>');	}require_once $index_dir.'include/code/code_db_object.php';require_once $index_dir.'include/code/code_fetch_site_vars.php';$lock_name=$reg8log_db->quote_smart('reg8log--lockdown_bypass-'.$_GET['username']."--$site_key");$reg8log_db->query("select get_lock($lock_name, -1)");$_username=$reg8log_db->quote_smart($_GET['username']);$query='select * from `lockdown_bypass` where `username`='.$_username.' limit 1';if($reg8log_db->result_num($query)) {  $rec=$reg8log_db->fetch_row();  $num_requests=$rec['num_requests'];  $emails_sent=$rec['emails_sent'];  $key=$rec['key'];  if($rec['last_attempt']!=$last_attempt) $bypass_record_expired=true;  else if($num_requests>=3) $captcha_needed=true;}else $emails_sent=$num_requests=-1;if(isset($captcha_needed)) {	require $index_dir.'include/code/code_sess_start.php';	$captcha_verified=isset($_SESSION['captcha_verified']);}do {//goto statement not supported in PHP < 5.3; so i use do ... while(false) + break in this specific scenario instead.if(!isset($_POST['email']))  break;require $index_dir.'include/code/code_prevent_xsrf.php';if($_POST['email']==='') $err_msgs[]='Email field is empty!';else {	$email_re='/^[a-z0-9_\-+\.]+@([a-z0-9\-+]+\.)+[a-z]{2,5}$/i';	if(!preg_match($email_re, $_POST['email'])) $err_msgs[]='Email format is invalid!';}if(isset($captcha_needed) and !$captcha_verified) require $index_dir.'include/code/code_verify_captcha.php';if(isset($err_msgs)) break;$query1='select * from `accounts` where `username`='.$_username.' limit 1';require $index_dir.'include/info/info_register.php';$expired1=time()-$email_verification_time;$expired2=time()-$admin_confirmation_time;$query2='select * from `pending_accounts` where `username`='.$_username." and (`email_verification_key`='' or `email_verified`=1 or `timestamp`>=".$expired1.') and (`admin_confirmed`=1 or `timestamp`>='.$expired2.') limit 1';if($reg8log_db->result_num($query1) or $reg8log_db->result_num($query2)) {  $username_exists=1;  $rec=$reg8log_db->fetch_row();  $email=$rec['email'];}else {  $email=false;  $username_exists=0;}require_once $index_dir.'include/func/func_random.php';$new_key=random_string(22);$tmp22=$emails_sent;if($_POST['email']===$email and ($max_lockdown_bypass_emails===-1 or $emails_sent<$max_lockdown_bypass_emails)) if($emails_sent<255) $tmp22++;if($num_requests<255) $num_requests++;if($num_requests>0) {  if(!isset($bypass_record_expired))    $query='update `lockdown_bypass` set `username_exists`='.$username_exists.', `num_requests`='.$num_requests.', `emails_sent`='.$tmp22.' where `username`='.$_username.' limit 1';  else {    $key=$new_key;    $query='update `lockdown_bypass` set `username_exists`='.$username_exists.", `num_requests`=1, `emails_sent`=0, `key`='".$key."', `last_attempt`=".$last_attempt.' where `username`='.$_username.' limit 1';  }}else {  $key=$new_key;  $query='insert into `lockdown_bypass` (`username`, `username_exists`, `num_requests`, `emails_sent`, `key`, `last_attempt`) values'."($_username, $username_exists, 1, 0, '$key', $last_attempt)";}$reg8log_db->query($query);if($_POST['email']===$email and ($max_lockdown_bypass_emails===-1 or $emails_sent<$max_lockdown_bypass_emails)) require $index_dir.'include/code/code_email_bypass_link.php';if(isset($captcha_needed)) unset($_SESSION['captcha_verified']);require $index_dir.'include/code/code_set_submitted_forms_cookie.php';$success_msg='<h3>An email is sent to '."'".'<span style="white-space: pre; color: #080;">'.htmlspecialchars($_POST['email'], ENT_QUOTES, 'UTF-8').'</span>'."'".',<br>if that is the correct email address of the account '."'".'<span style="white-space: pre; color: #080;">'.htmlspecialchars($_GET['username'], ENT_QUOTES, 'UTF-8').'</span>'."'";if($max_lockdown_bypass_emails!=-1) $success_msg.=" and<br>the maximum number of lockdown-bypass emails ($max_lockdown_bypass_emails) is not reached";$success_msg.='.</h3>';$no_specialchars=true;require $index_dir.'include/page/page_success.php';require $index_dir.'include/info/info_cleanup.php';if(mt_rand(1, floor(1/$cleanup_probability))==1) {	$table_name='lockdown_bypass';	require $index_dir.'include/code/code_failed_logins_expired_cleanup.php';}if(mt_rand(1, floor(1/$cleanup_probability))==1) {	$table_name='lockdown_bypass';	require $index_dir.'include/code/code_failed_logins_size_cleanup.php';}exit;} while(false);require $index_dir.'include/page/page_lockdown_bypass_request_form.php';?>